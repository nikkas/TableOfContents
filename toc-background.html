</html>
<head>
  <script>
    //contains extension's only functionality.
    var tocCurrentTabId= null;

    chrome.browserAction.setBadgeBackgroundColor({color:[0,0,255,255]});

    /**
     *
     *
     * @modified 2010.10.03
     * @since 2010.10.03 (v00.02.03)
     * @author HoKoNoUmo
     */
    chrome.browserAction.onClicked.addListener(
      function(tab){
        tocCurrentTabId=tab.id;
        chrome.tabs.sendRequest(tab.id, {type:"toggleState"});
      }
    );

    /**
     * Changes the on/off badge-text, listening from pages.
     *
     * @modified 2010.10.03
     * @since 2010.10.03 (v00.02.03)
     * @author HoKoNoUmo
     */
    chrome.extension.onRequest.addListener(
      function(request, sender, sendResponse) {
        if (tocCurrentTabId != sender.tab.id) {
          return;
        }
        if (request.type==="setStateText") {
          fSetStateText(request.value);
        }
      }
    );

    chrome.tabs.onRemoved.addListener(
    	  function(idTab){
        tocCurrentTabId= null;
        fSetStateText(0);
      }
    );

    /**
     *
     *
     * @modified 2010.10.03
     * @since 2010.10.03 (v00.02.03)
     * @author HoKoNoUmo
     */
    chrome.tabs.onSelectionChanged.addListener(
      function (tabId, selectInfo) {
        //ppp current if on, looses its state. 2010.10.18
        fSetStateText(0);
      }
    );

    /**
     * On non-current-tab, do nothing.<br/>
     * On current-tab, on "reload" set off-state. On click, set
     * the existing-state.
     *
     * @modified 2010.10.18
     * @since 2010.10.03 (v00.02.03)
     * @author HoKoNoUmo
     */
    chrome.tabs.onUpdated.addListener(
      function (tabId, changeInfo, tab) {
        if (tocCurrentTabId!=tab.id) {
          return;
        }
        fSetStateText(0);
        chrome.tabs.sendRequest(tabId,{type:"requestState"});
      }
    );


    /**
     * Will display a BadgeText if we can display or no the ToC
     *
     * @modified 2010.10.03
     * @since 2010.10.03 (v00.02.03)
     * @author HoKoNoUmo
     */
    function fSetStateText(nPowerState) {
      switch (nPowerState) {
        case 0:
          chrome.browserAction.setBadgeText({text: ""});//OFF STATE
          break;
        case 1:
          chrome.browserAction.setBadgeText({text: "on"});
          break;
      }
    }



//    FUNCTIONS:

//    chrome.browserAction.onClicked.addListener()
//    chrome.extension.onRequest.addListener()
//    chrome.tabs.onRemoved.addListener()
//    chrome.tabs.onSelectionChanged.addListener()
//    chrome.tabs.onUpdated.addListener()

//    function deactivate(tab)
//    function fSendMessage(sMeas)
//    function fSetStateText(nPowerState)

  </script>
</head>

</html>